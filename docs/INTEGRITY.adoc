// SPDX-License-Identifier: AGPL-3.0-or-later
= mark2-integrity: XML Validation and Chain of Custody
:toc: left
:toclevels: 3
:sectnums:
:icons: font

== Overview

This document explains the integrity subsystem for eTMA marking, covering:

* Why XML validation is critical for DOCX and FHI files
* The chain of custody system for defending against disputes
* How to differentiate tampering from accidental corruption
* Tool usage reference

== The XML Fragility Problem

=== The "7/44 Incident"

During testing, a DOCX file with injected Word comments was completely unusable. LibreOffice reported:

----
Read-Error
Format error discovered in the file in sub-document word/comments.xml
at 7,44(row,col)
----

The cause: an unescaped ampersand (`&`) in the comment text "Barr & Hayne". XML parsers are strict; a single malformed character destroys the entire file.

=== Why XML Fails Hard

XML is a strict format. Unlike HTML (which browsers will try to render even when malformed), XML parsers abort on the first error. This is by design for data integrity, but it means:

[WARNING]
====
A single misplaced character in any XML file inside a DOCX will make the entire document unopenable.
====

=== XML's Five Reserved Characters

These characters MUST be escaped in XML content:

[cols="1,2,3"]
|===
| Character | Entity | Context

| `&`
| `\&amp;`
| The most common problem - appears in names, references, URLs

| `<`
| `\&lt;`
| Start of tags - dangerous in code samples, math

| `>`
| `\&gt;`
| End of tags - often escaped for symmetry

| `"`
| `\&quot;`
| In attribute values: `attr="value with &quot;quotes&quot;"`

| `'`
| `\&apos;`
| In single-quoted attributes
|===

=== Other XML Failure Points

==== Encoding Issues

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<!-- If actual content is ISO-8859-1, the file breaks -->
----

**Problem**: Declared encoding doesn't match actual content.

**Common**: Students copy-pasting from Word (Windows-1252) into files declared as UTF-8.

==== Malformed Structure

[source,xml]
----
<paragraph>Text <bold>important</paragraph></bold>  <!-- Wrong nesting -->
<item>No closing tag  <!-- Missing close -->
<data>]]></data>  <!-- CDATA end marker without CDATA start -->
----

==== Namespace Corruption

[source,xml]
----
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <p>Text</p>  <!-- Missing w: prefix - invalid! -->
</w:document>
----

==== Invalid Unicode

* Null bytes (`\x00`) - Never valid in XML
* Control characters (`\x01-\x08`, `\x0B-\x0C`, `\x0E-\x1F`) - Invalid in XML 1.0
* Surrogate pairs - Must be properly formed

== DOCX File Structure

A `.docx` file is a ZIP archive containing multiple XML files. Understanding this structure is essential for validation and repair.

=== Critical Files in a DOCX

----
document.docx (ZIP)
├── [Content_Types].xml          # MIME type registry
├── _rels/
│   └── .rels                    # Root relationships
├── word/
│   ├── document.xml             # Main document content
│   ├── styles.xml               # Paragraph/character styles
│   ├── settings.xml             # Document settings
│   ├── fontTable.xml            # Font definitions
│   ├── comments.xml             # Comments (if any)
│   ├── footnotes.xml            # Footnotes (if any)
│   ├── header1.xml              # Headers
│   ├── footer1.xml              # Footers
│   └── _rels/
│       └── document.xml.rels    # Document relationships
├── docProps/
│   ├── core.xml                 # Author, dates
│   └── app.xml                  # Application info
└── theme/
    └── theme1.xml               # Visual theme
----

=== Failure Cascade

If ANY of these XML files is malformed:

1. The DOCX cannot be opened
2. Most applications give unhelpful error messages
3. Recovery tools may lose formatting or content
4. Students/tutors lose work

=== Adding Comments to DOCX

When injecting Word comments, three files must be modified:

1. **`[Content_Types].xml`** - Register comments.xml content type
2. **`word/_rels/document.xml.rels`** - Add relationship to comments.xml
3. **`word/comments.xml`** - The actual comments (new file)
4. **`word/document.xml`** - Add comment range markers

==== Comment Structure in document.xml

Comments must be marked at the run (`<w:r>`) level, NOT inside text:

[source,xml]
----
<!-- CORRECT: markers at run level -->
<w:p>
  <w:r>
    <w:t>Normal text </w:t>
  </w:r>
  <w:commentRangeStart w:id="0"/>
  <w:r>
    <w:t>highlighted text</w:t>
  </w:r>
  <w:commentRangeEnd w:id="0"/>
  <w:r>
    <w:commentReference w:id="0"/>
  </w:r>
  <w:r>
    <w:t> more text</w:t>
  </w:r>
</w:p>
----

[source,xml]
----
<!-- WRONG: markers inside text element - WILL CORRUPT FILE -->
<w:p>
  <w:r>
    <w:t>Text <w:commentRangeStart/>word<w:commentRangeEnd/> more</w:t>
  </w:r>
</w:p>
----

== Chain of Custody

=== Why Independent Verification Matters

The OU system records submission timestamps, but these could theoretically be disputed. An independent chain of custody provides:

1. **Cryptographic hashes** - Prove file content hasn't changed
2. **RFC 3161 timestamps** - Third-party proof of time
3. **Immutable audit trail** - Every action recorded

=== The Workflow

----
Student Submits
      │
      ▼
┌─────────────────┐
│  OU Downloads   │  (Student claims early submission)
│  to Tutor       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  mark2 INGRESS  │ ◀── Hash + Timestamp + Validate
│  (Receipt)      │     Creates immutable record
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Tutor Marks    │ ◀── SNAPSHOT on each save
│  (Multiple edits)│     Links to previous hash
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  mark2 EGRESS   │ ◀── Final validation + hash
│  (Return)       │     BLOCKS if corrupt
└────────┬────────┘
         │
         ▼
    Upload to OU
----

=== What Gets Recorded

Each integrity record contains:

[cols="2,4"]
|===
| Field | Purpose

| `filepath`
| Which file this record describes

| `content_hash`
| SHA256 of file content (proves no changes)

| `timestamp`
| RFC 3161 token from trusted TSA

| `previous_hash`
| Link to previous state (chain)

| `event_type`
| INGRESS, EDIT, SNAPSHOT, EGRESS

| `signature`
| Ed25519 signature by tutor's key
|===

=== Defending Against Disputes

**Scenario**: Student claims "I submitted before the deadline, the system timestamp is wrong"

**Defence**: The INGRESS record shows:
1. Cryptographic hash matched the received file
2. RFC 3161 timestamp from DigiCert proves exact time
3. Chain from ingress to egress is unbroken
4. Any tampering would break the hash chain

== Validation Pipeline

=== What mark2-integrity Validates

==== For DOCX Files

1. **ZIP Integrity** - Is it a valid ZIP archive?
2. **Required Files** - Does it contain `[Content_Types].xml`, `document.xml`?
3. **XML Well-formedness** - Every `.xml` file must parse
4. **Namespace Consistency** - No orphaned namespace prefixes
5. **No Macros** - Security check for `vbaProject.bin`
6. **Relationships** - All referenced files exist
7. **File Size** - Sanity check (< 100MB default)

==== For FHI Files

1. **XML Well-formedness** - Must parse cleanly
2. **Required Elements** - `student_details`, `submission_details`
3. **Encoding Match** - Content matches declared encoding
4. **Character Set** - No invalid control characters

=== Validation Strictness

The pipeline uses `xmllint --noout` for validation:

----
$ xmllint --noout word/comments.xml
word/comments.xml:7: parser error : xmlParseEntityRef: no name
----

This catches:
* Unescaped entities
* Mismatched tags
* Invalid characters
* Encoding issues

== Tampering vs Corruption Forensics

When validation fails, it's important to understand whether the damage was:

* **Accidental corruption** - Disk errors, transfer problems, software bugs
* **Deliberate tampering** - Attempt to modify grades, dates, or content

=== Tampering Indicators

[cols="1,3"]
|===
| Indicator | What It Suggests

| Changes in dates/scores
| Direct evidence of tampering intent

| Cleanly modified XML
| Required understanding of format

| Only "beneficial" changes
| Changed marks up, not down

| Metadata inconsistencies
| Edit dates that predate creation

| Preserved file structure
| Sophisticated attacker
|===

=== Corruption Indicators

[cols="1,3"]
|===
| Indicator | What It Suggests

| Random byte sequences
| Bit flips, memory errors

| Truncated files
| Transfer interruption

| Null bytes injected
| Binary corruption

| Encoding scrambling
| Character set issues

| ZIP structure damage
| Storage/transfer errors
|===

=== The Heuristic Analysis

The `diagnose` command assigns likelihood scores:

----
$ mark2-integrity diagnose /path/to/file.docx

=== Diagnostic Analysis ===
File: damaged.docx
Hash: a1b2c3d4...

TAMPERING INDICATORS: 2
  - Specific content modification detected
  - Error occurred in sensitive field (score/date)

CORRUPTION INDICATORS: 0
  - (none detected)

LIKELIHOOD ASSESSMENT:
  More likely TAMPERING than accidental corruption
  Confidence: HIGH
----

== Tool Reference

=== mark2-integrity

Location: `~/.local/bin/mark2-integrity`

==== Commands

[source,bash]
----
# Record receipt of submission (creates chain start)
mark2-integrity ingest /path/to/submission/folder

# Validate without recording
mark2-integrity validate /path/to/file.docx

# Create snapshot during marking
mark2-integrity snapshot /path/to/file.docx

# Validate and record return (BLOCKS if invalid)
mark2-integrity egress /path/to/submission/folder

# Verify file against recorded hash
mark2-integrity verify /path/to/file.docx

# Show chain of custody
mark2-integrity chain <submission-id>

# Forensic analysis of damage
mark2-integrity diagnose /path/to/file.docx
----

==== Environment Variables

[cols="2,3,2"]
|===
| Variable | Purpose | Default

| `MARK2_INTEGRITY_DIR`
| Where chain data is stored
| `~/.mark2-integrity`

| `MARK2_TSA_URL`
| RFC 3161 timestamp server
| `http://timestamp.digicert.com`

| `MARK2_KEY_FILE`
| Ed25519 signing key
| `~/.mark2-integrity/key.pem`
|===

==== Exit Codes

[cols="1,4"]
|===
| Code | Meaning

| 0 | Success, file valid
| 1 | Validation failed
| 2 | File not found
| 3 | Chain verification failed
| 4 | Timestamp verification failed
|===

=== Idris2 XML Toolkit

For type-safe XML handling, see `idris2-xml-7-44-toolkit`:

[source,idris]
----
-- Safe infiltration (escapes all reserved characters)
infiltrate : String -> String

-- Safe exfiltration (unescapes entities)
exfiltrate : String -> String
----

The toolkit makes XML escaping errors impossible at compile time.

== Best Practices

=== For Tutors

1. **Always ingest before marking** - Creates baseline hash
2. **Use snapshot regularly** - After significant marking progress
3. **Never skip egress** - Validates before upload
4. **Check validation errors** - Don't ignore warnings

=== For System Administrators

1. **Backup chain data** - The `~/.mark2-integrity` folder is critical
2. **Verify TSA connectivity** - RFC 3161 requires network access
3. **Rotate signing keys** - Per marking season

=== For Developers

1. **Never concatenate XML** - Always use proper escaping
2. **Validate after every modification** - Run xmllint
3. **Test with edge cases** - Names with `&`, `<`, quotes
4. **Preserve encoding declarations** - Match actual content

== Related Documentation

* link:FHI-SCHEMA.adoc[FHI Schema Specification]
* link:architecture/overview.adoc[Architecture Overview]
* link:architecture/decisions.adoc[Architecture Decision Records]

== Appendix: The 7/44 Test Cases

These DOCX files demonstrate the XML fragility problem:

[cols="3,1,3"]
|===
| File | Status | Notes

| `TEST_COMMENT_v1.docx`
| INVALID
| Unescaped `&` in comments.xml

| `TEST_COMMENT_v3.docx`
| INVALID
| Same error

| `TEST_COMMENT_v4.docx`
| VALID
| Proper `\&amp;` escaping

| `TEST_COMMENT_v5.docx`
| VALID
| Surgical comment targeting
|===

The name "7/44" refers to the error location: line 7, column 44 of comments.xml where the unescaped `&` appeared.
