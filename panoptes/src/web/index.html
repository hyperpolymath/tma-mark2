<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panoptes - File Scanner Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-emerald-400">üëÅÔ∏è Panoptes</h1>
                    <p class="text-slate-400">AI-Powered File Scanner</p>
                </div>
                <div id="stats" class="text-right">
                    <div class="text-sm text-slate-500">Loading stats...</div>
                </div>
            </div>
        </header>

        <!-- Search -->
        <div class="mb-8">
            <div class="relative">
                <input
                    type="text"
                    id="search"
                    placeholder="Search files..."
                    class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:border-emerald-500 transition"
                    hx-get="/api/files/search"
                    hx-trigger="keyup changed delay:500ms"
                    hx-target="#file-list"
                    hx-include="this"
                    name="q"
                >
                <svg class="absolute right-4 top-3.5 w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Sidebar - Tags -->
            <aside class="lg:col-span-1">
                <div class="bg-slate-800 rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        Tags
                    </h2>
                    <div id="tag-list" class="space-y-2">
                        <div class="text-slate-500 text-sm">Loading tags...</div>
                    </div>
                </div>
            </aside>

            <!-- Main - File List -->
            <main class="lg:col-span-3">
                <div class="bg-slate-800 rounded-lg">
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                        <h2 class="text-lg font-semibold">Recent Files</h2>
                        <button
                            class="px-3 py-1 bg-emerald-600 hover:bg-emerald-500 rounded text-sm transition"
                            hx-get="/api/files"
                            hx-target="#file-list"
                        >
                            Refresh
                        </button>
                    </div>
                    <div id="file-list" class="divide-y divide-slate-700">
                        <div class="p-8 text-center text-slate-500">
                            Loading files...
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadFiles();
            loadTags();
        });

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('stats').innerHTML = `
                        <div class="text-2xl font-bold text-emerald-400">${data.data.file_count}</div>
                        <div class="text-sm text-slate-500">Files Analyzed</div>
                    `;
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        async function loadFiles() {
            try {
                const response = await fetch('/api/files?limit=20');
                const data = await response.json();
                if (data.success) {
                    renderFiles(data.data);
                }
            } catch (e) {
                console.error('Failed to load files:', e);
            }
        }

        async function loadTags() {
            try {
                const response = await fetch('/api/tags');
                const data = await response.json();
                if (data.success) {
                    renderTags(data.data);
                }
            } catch (e) {
                console.error('Failed to load tags:', e);
            }
        }

        function renderFiles(files) {
            const container = document.getElementById('file-list');
            if (files.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-slate-500">
                        No files found. Run <code class="bg-slate-700 px-2 py-1 rounded">panoptes scan</code> to analyze files.
                    </div>
                `;
                return;
            }

            container.innerHTML = files.map(file => `
                <div class="p-4 hover:bg-slate-700/50 transition fade-in">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium truncate">${file.current_name}</p>
                            <p class="text-sm text-slate-400 truncate">${file.path}</p>
                            ${file.description ? `<p class="text-sm text-slate-500 mt-1">${file.description}</p>` : ''}
                        </div>
                        <div class="ml-4 flex-shrink-0 text-right">
                            ${file.confidence ? `
                                <div class="text-sm">
                                    <span class="text-emerald-400">${Math.round(file.confidence * 100)}%</span>
                                    <span class="text-slate-500">confidence</span>
                                </div>
                            ` : ''}
                            <div class="text-xs text-slate-500">${formatSize(file.size)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTags(tags) {
            const container = document.getElementById('tag-list');
            if (tags.length === 0) {
                container.innerHTML = `
                    <div class="text-slate-500 text-sm">No tags yet</div>
                `;
                return;
            }

            container.innerHTML = tags.map(tag => `
                <button
                    class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 transition flex items-center"
                    onclick="filterByTag('${tag.name}')"
                >
                    <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${tag.color || '#10b981'}"></span>
                    ${tag.name}
                </button>
            `).join('');
        }

        async function filterByTag(tagName) {
            try {
                const response = await fetch(`/api/tags/${encodeURIComponent(tagName)}/files`);
                const data = await response.json();
                if (data.success) {
                    renderFiles(data.data);
                }
            } catch (e) {
                console.error('Failed to filter by tag:', e);
            }
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }
    </script>
</body>
</html>
