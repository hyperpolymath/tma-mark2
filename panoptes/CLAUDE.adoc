// SPDX-FileCopyrightText: 2024 Panoptes Contributors
// SPDX-License-Identifier: MIT
= Panoptes - Claude AI Assistant Guide
:toc: left
:toclevels: 3
:icons: font

== Overview

This document provides context for AI assistants (like Claude) working on the Panoptes codebase.

== Project Summary

Panoptes is a local AI-powered file scanner that:

* Analyzes files using vision models (Moondream via Ollama)
* Generates intelligent filenames and tags
* Runs entirely offline with no cloud dependencies
* Supports multiple file types via plugin architecture

== Architecture

=== Directory Structure

[source]
----
panoptes/
├── src/
│   ├── main.rs              # CLI entry point
│   ├── lib.rs               # Library root
│   ├── error.rs             # Error types
│   ├── analyzers/           # File type analyzers
│   │   ├── mod.rs           # Analyzer trait & registry
│   │   ├── image.rs         # Image analyzer
│   │   ├── pdf.rs           # PDF analyzer
│   │   ├── audio.rs         # Audio analyzer
│   │   ├── video.rs         # Video analyzer
│   │   ├── code.rs          # Code analyzer
│   │   ├── document.rs      # Document analyzer
│   │   └── archive.rs       # Archive analyzer
│   ├── config/
│   │   └── mod.rs           # Configuration handling
│   ├── db/
│   │   └── mod.rs           # SQLite database
│   ├── ollama.rs            # Ollama API client
│   ├── history.rs           # Undo/redo history
│   ├── watcher.rs           # File system watcher
│   └── web/
│       └── mod.rs           # Web dashboard
├── config.json              # JSON configuration
├── config.ncl               # Nickel configuration
├── Cargo.toml               # Rust dependencies
├── Justfile                 # Task runner recipes
└── docs/                    # Documentation
----

=== Key Components

==== Analyzer Trait

All file analyzers implement this trait:

[source,rust]
----
#[async_trait]
pub trait FileAnalyzer: Send + Sync {
    fn name(&self) -> &'static str;
    fn supported_extensions(&self) -> &[&str];
    fn priority(&self) -> u8;
    async fn analyze(&self, path: &Path, config: &Config) -> Result<AnalysisResult>;
}
----

==== Configuration

Configuration sources (in priority order):

1. Built-in defaults
2. System config (`/etc/panoptes/config.json`)
3. User config (`~/.config/panoptes/config.json`)
4. Project config (`./config.json`)
5. Environment variables (`PANOPTES_*`)
6. CLI flags

==== Database Schema

[source,sql]
----
-- Core tables
files(id, path, hash, size, mime_type, original_name, suggested_name, analyzed_at)
tags(id, name, color)
file_tags(file_id, tag_id)
categories(id, name, parent_id)
----

== Development Guidelines

=== Code Style

* All public APIs must have documentation
* SPDX license headers on all files
* `#![forbid(unsafe_code)]` - no unsafe allowed
* Run `cargo fmt` and `cargo clippy` before commits

=== Testing

* Unit tests in same file as code
* Integration tests in `tests/` directory
* Use `proptest` for property-based testing

=== Error Handling

* Use `thiserror` for error definitions
* Wrap external errors appropriately
* Provide context in error messages

== Common Tasks

=== Adding a New Analyzer

1. Create `src/analyzers/newtype.rs`
2. Implement `FileAnalyzer` trait
3. Register in `AnalyzerRegistry::new()`
4. Add feature flag if optional
5. Update documentation

=== Adding a CLI Command

1. Add variant to `Commands` enum in `main.rs`
2. Implement handler function
3. Add tests
4. Update README and wiki

=== Adding Configuration Option

1. Add field to `AppConfig` struct
2. Add default value
3. Update JSON schema
4. Update Nickel schema
5. Document in README

== RSR Gold Compliance

This project follows RSR (Rhodium Standard Repository) Gold standards:

=== Required Files

* [x] README.adoc
* [x] LICENSE.txt
* [x] SECURITY.md
* [x] CONTRIBUTING.adoc
* [x] CODE_OF_CONDUCT.adoc
* [x] GOVERNANCE.adoc
* [x] MAINTAINERS.md
* [x] CHANGELOG.md
* [x] ROADMAP.md
* [x] FUNDING.yml
* [x] REVERSIBILITY.md
* [x] CLAUDE.adoc (this file)

=== Required Directories

* [x] `.well-known/` with security.txt, ai.txt
* [x] `docs/wiki/` with documentation pages

=== Technical Requirements

* [x] Nix flake for reproducibility
* [x] Nickel for type-safe configuration
* [x] Just for task running
* [x] Containerfile for Podman/Docker

== Working with Claude

=== When Asked to Modify Code

1. Read relevant existing code first
2. Follow existing patterns
3. Add tests for new functionality
4. Update documentation

=== When Asked to Debug

1. Check error types in `error.rs`
2. Look for similar patterns in codebase
3. Consider async context issues
4. Check Ollama connectivity

=== When Asked about Architecture

1. Refer to this document
2. Check the module structure
3. Review trait definitions
4. Consider configuration flow

== Important Notes

* Files are processed locally only
* Ollama must be running for AI features
* All operations are reversible via history
* Database is SQLite (portable, embedded)

== Contact

* Issues: GitHub Issues
* Security: See SECURITY.md
* Questions: GitHub Discussions
