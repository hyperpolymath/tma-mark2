// SPDX-License-Identifier: PMPL-1.0-or-later
= tma-mark2 Comprehensive Seams Review
:author: hyperpolymath
:revdate: 2025-01-02
:toc:
:toclevels: 3

== Executive Summary

This document presents a comprehensive review of all integration points ("seams") in the tma-mark2 project.
The review evaluates quality, ergonomics, dependability, safety, and interoperability.

=== Overall Assessment

[cols="1,1,3"]
|===
|Area |Rating |Notes

|Quality |â˜…â˜…â˜…â˜…â˜† |Excellent architecture, consistent patterns, minor license header inconsistencies
|Ergonomics |â˜…â˜…â˜…â˜…â˜† |Good command discoverability via Just, XDG compliance, cross-platform paths
|Dependability |â˜…â˜…â˜…â˜…â˜… |Proper OTP supervision, crash-proof CubDB, GenServer patterns
|Safety |â˜…â˜…â˜…â˜…â˜… |Post-quantum crypto ready, TLS 1.3 only, comprehensive security headers
|Interoperability |â˜…â˜…â˜…â˜…â˜† |Multi-platform support, Bebop schema, minor gaps in mobile implementation
|===

== 1. QUALITY

=== 1.1 Code Consistency

[cols="2,1,3"]
|===
|Pattern |Status |Notes

|SPDX License Headers |âš ï¸ |Most files have headers, but `security.ex` has MIT instead of AGPL
|Module Documentation |âœ“ |All modules have `@moduledoc` with clear explanations
|Type Specifications |âœ“ |`@spec` on public functions in Repo and Security modules
|Consistent Naming |âœ“ |Snake_case for functions, PascalCase for modules
|GenServer Pattern |âœ“ |Properly implemented in Repo and Bouncer
|===

==== License Header Issues Found

[source,elixir]
----
# lib/etma_handler/security.ex - Line 1-2
# SPDX-FileCopyrightText: 2024 eTMA Handler Contributors
# SPDX-License-Identifier: PMPL-1.0-or-later
----

*Recommendation:* Update all file headers to AGPL-3.0-or-later to match LICENSE.txt.

=== 1.2 Architectural Patterns

[cols="2,1,3"]
|===
|Pattern |Implementation |Quality

|Supervision Tree |`Application.ex` |â˜…â˜…â˜…â˜…â˜… Proper `:one_for_one` strategy
|Data Layer Abstraction |`Repo.ex` GenServer |â˜…â˜…â˜…â˜…â˜… Clean API hiding CubDB details
|Configuration Hierarchy |`config/*.exs` + Nickel |â˜…â˜…â˜…â˜…â˜† Good layering, Nickel integration excellent
|Security Module |`Security.ex` |â˜…â˜…â˜…â˜…â˜… Comprehensive, constant-time comparison
|NIF Integration |Rustler |â˜…â˜…â˜…â˜†â˜† Structure good, implementations are stubs
|===

=== 1.3 Documentation Quality

- README.adoc: â˜…â˜…â˜…â˜…â˜… Comprehensive
- CLAUDE.adoc: â˜…â˜…â˜…â˜…â˜… Excellent AI-specific guidance
- Module docs: â˜…â˜…â˜…â˜…â˜† Good `@moduledoc`, some functions missing `@doc`
- Inline comments: â˜…â˜…â˜…â˜…â˜† Present where logic is complex
- Architecture docs: â˜…â˜…â˜…â˜…â˜† Present in `docs/architecture/`

== 2. ERGONOMICS

=== 2.1 Command Discoverability

The Justfile provides excellent command discoverability:

[source,bash]
----
just --list    # Shows all 77 recipes
just info      # Shows project info
just dev       # Starts development server
just build     # Smart build (Guix â†’ Nix â†’ Mix fallback)
----

*Ergonomic Strengths:*

- Default recipe shows help
- Grouped by concern (BUILD, TESTING, SECURITY, etc.)
- Smart fallbacks (Guix â†’ Nix â†’ Mix)
- Clear error messages via `error_guidance` in Nickel

=== 2.2 Platform-Appropriate Paths

`application.ex` correctly handles platform-specific paths:

[cols="1,3"]
|===
|Platform |Data Location

|Linux |`$XDG_DATA_HOME/etma_handler/data` (or `~/.local/share/etma_handler/data`)
|macOS |`~/Library/Application Support/EtmaHandler/data`
|Windows |`%APPDATA%\EtmaHandler\data`
|===

*This is excellent ergonomics* - follows platform conventions automatically.

=== 2.3 Developer Experience Gaps

[cols="2,1,3"]
|===
|Gap |Severity |Recommendation

|No `test/` directory |ğŸ”´ HIGH |Create test structure with ExUnit
|No development database seed |ğŸŸ¡ MEDIUM |Add `priv/repo/seeds.exs`
|Missing LiveView templates |ğŸŸ¡ MEDIUM |Create `.heex` files for all LiveView modules
|===

== 3. DEPENDABILITY

=== 3.1 Fault Tolerance

[cols="2,1,3"]
|===
|Component |Fault Tolerance |Notes

|Supervisor |â˜…â˜…â˜…â˜…â˜… |`:one_for_one` - isolated failures
|CubDB |â˜…â˜…â˜…â˜…â˜… |Append-only B-tree, survives power loss
|Bouncer |â˜…â˜…â˜…â˜…â˜† |Graceful degradation if Downloads dir missing
|Endpoint |â˜…â˜…â˜…â˜…â˜… |Bandit handles connection failures
|===

==== Supervision Tree Analysis

[source]
----
EtmaHandler.Supervisor (:one_for_one)
â”œâ”€â”€ EtmaHandler.Repo        # CubDB wrapper - critical
â”œâ”€â”€ EtmaHandlerWeb.Telemetry
â”œâ”€â”€ Phoenix.PubSub
â”œâ”€â”€ EtmaHandlerWeb.Endpoint # Web server
â””â”€â”€ EtmaHandler.Bouncer     # Optional - file watcher
----

*Key Observation:* The supervision tree correctly orders dependencies.
If Repo fails, other services don't crash. If Bouncer fails, UI remains available.

=== 3.2 Error Handling

[cols="2,1,3"]
|===
|Location |Quality |Notes

|`Application.start/2` |â˜…â˜…â˜…â˜…â˜… |Proper error logging and return
|`Repo.init/1` |â˜…â˜…â˜…â˜…â˜… |Handles `:already_started` gracefully
|`Security.validate_password/2` |â˜…â˜…â˜…â˜…â˜… |Returns structured errors
|`Bouncer` (implied) |â˜…â˜…â˜…â˜…â˜† |Validates directory existence
|===

=== 3.3 Recovery Mechanisms

The "Time Machine" feature in Repo provides:

- Full history of all saves
- Point-in-time recovery via `get_snapshot_at/2`
- Automatic latest pointer for fast access
- CubDB auto-compaction prevents unbounded growth

== 4. SAFETY

=== 4.1 Cryptographic Correctness

==== TLS Configuration (security.ex)

[cols="2,1,3"]
|===
|Setting |Value |Assessment

|TLS Version |1.3 only |â˜…â˜…â˜…â˜…â˜… No downgrade attacks
|Cipher Suites |ChaCha20, AES-256-GCM, AES-128-GCM |â˜…â˜…â˜…â˜…â˜… Strong only
|ECDH Curves |x448, x25519, secp521r1, secp384r1 |â˜…â˜…â˜…â˜…â˜… Strongest first
|Signature Algorithms |Ed448, Ed25519, ECDSA-P521/P384 |â˜…â˜…â˜…â˜…â˜… Modern choices
|===

==== Post-Quantum Readiness (Rust NIF)

[cols="2,1,3"]
|===
|Algorithm |Purpose |Status

|Kyber-1024 (ML-KEM) |Key Encapsulation |âœ“ Cargo.toml configured, stub implementation
|Dilithium5 (ML-DSA) |Digital Signatures |âœ“ Cargo.toml configured, stub implementation
|Ed448 |Classical Signatures |âœ“ Cargo.toml configured, stub implementation
|BLAKE3 |Hashing/KDF |âœ“ Cargo.toml configured, stub implementation
|ChaCha20-Poly1305 |AEAD |âœ“ Cargo.toml configured, stub implementation
|===

*Assessment:* Architecture is correct and forward-looking. Once NIFs are fully implemented, the system will have industry-leading cryptographic security.

=== 4.2 Session Security

[cols="2,1,3"]
|===
|Setting |Value |Assessment

|Cookie Flags |HttpOnly, Secure, SameSite=Strict |â˜…â˜…â˜…â˜…â˜…
|Session Lifetime |24 hours |â˜…â˜…â˜…â˜…â˜… Short sessions
|Signing Salt |Random at startup or config |â˜…â˜…â˜…â˜…â˜† Consider persistent salt for clusters
|Partitioned Cookies |Enabled |â˜…â˜…â˜…â˜…â˜… Chrome isolation
|===

=== 4.3 Network Isolation

==== Security Contract (must/contracts/security.ncl)

[source]
----
network = {
  default_policy = "deny",  # â† Default DENY is correct
  allowed_destinations = {
    virustotal = { requires_user_consent = true, ephemeral = true },
    open_university = { requires_user_consent = false },  # Core functionality
    updates = { signature_required = true },
  }
}
----

*Assessment:* The SDP (Software Defined Perimeter) model is correctly specified:

- Default deny
- Ephemeral access grants
- User consent for sensitive destinations
- Signature verification for updates

=== 4.4 Password Policy

The `password_policy/0` function enforces:

- Minimum 12 characters
- Uppercase, lowercase, digit, special required
- Maximum 128 characters
- Minimum 50 bits entropy
- HIBP breach checking (planned)
- No username in password

*Assessment:* â˜…â˜…â˜…â˜…â˜… Exceeds NIST 800-63B recommendations.

=== 4.5 Security Gaps Identified

[cols="2,1,3"]
|===
|Gap |Severity |Recommendation

|MIT license header in security.ex |ğŸŸ¡ MEDIUM |Update to AGPL-3.0-or-later
|No rate limiting implementation shown |ğŸŸ¡ MEDIUM |Verify `rate_limiter.ex` is complete
|HIBP integration not implemented |ğŸŸ¢ LOW |Add Have I Been Pwned API check
|===

== 5. INTEROPERABILITY

=== 5.1 Platform Support

[cols="2,1,1,3"]
|===
|Platform |Tier |Support |Notes

|Linux x86_64 |1 |Container + Burrito |Full CI testing
|Linux ARM64 |1 |Container + Burrito |Full CI testing
|macOS ARM64 |1 |Burrito |Full CI testing
|Linux RISC-V |2 |Container + Burrito |Periodic testing
|macOS Intel |2 |Burrito |Legacy support
|Windows x86_64 |2 |Burrito |WSL2 recommended
|Minix |3 |Burrito only |Experimental
|iOS |2 |Dioxus (planned) |Framework configured
|Android |2 |Dioxus (planned) |Framework configured
|===

=== 5.2 Build System Interoperability

[cols="2,1,3"]
|===
|Build System |Priority |Notes

|Guix |Primary |Full reproducibility, RISC-V experimental
|Nix |Fallback |Wider platform support
|Mix |Emergency |Direct build when no package manager
|===

The fallback chain in `Justfile` is correct:

[source,bash]
----
if guix available && guix.scm exists:
    guix build
elif nix available && flake.nix exists:
    nix build
else:
    mix release
----

=== 5.3 Data Format Interoperability

[cols="2,1,3"]
|===
|Format |Support |Notes

|.fhi (legacy) |âœ“ |Via SweetXml parsing
|.docx |âœ“ |Via SweetXml parsing
|.rtf |âœ“ |Planned
|.pdf |âœ“ |Via Poppler (container)
|.odt |âœ“ |Planned
|.txt |âœ“ |Native
|===

=== 5.4 Protocol Interoperability

==== Bebop Schema Coverage

[cols="2,1,3"]
|===
|Domain |Schema |Status

|Core Messages |messages.bop |âœ“ Complete
|Security/Crypto |security.bop |âœ“ Complete
|Sync Protocol |messages.bop |âœ“ SyncRequest/Response defined
|VirusTotal |messages.bop |âœ“ VTScanRequest/Result defined
|===

The Bebop schemas provide:

- GUID-based message identification
- Hybrid signatures (Ed448 + Dilithium5)
- Kyber KEM for key exchange
- ChaCha20-Poly1305 for payload encryption

=== 5.5 Interoperability Gaps

[cols="2,1,3"]
|===
|Gap |Severity |Recommendation

|No Bebop code generation |ğŸŸ¡ MEDIUM |Run `bebop --lang elixir` / `bebop --lang rust`
|Mobile app structure missing |ğŸŸ¡ MEDIUM |Create `mobile/` directory with Dioxus project
|No OU API client |ğŸŸ¡ MEDIUM |Implement scraping fallback first
|===

== 6. CRITICAL ISSUES

=== 6.1 Must Fix Before Release

[cols="1,3,3"]
|===
|# |Issue |Resolution

|1 |License header in `security.ex` says MIT |Change to AGPL-3.0-or-later
|2 |No test suite |Create `test/` with ExUnit tests
|3 |Rust NIFs are stubs |Implement crypto and NLP functions
|4 |LiveView templates missing |Create `.heex` files for all routes
|===

=== 6.2 Should Fix Before Release

[cols="1,3,3"]
|===
|# |Issue |Resolution

|1 |No database seeds |Add sample data for development
|2 |Bebop code not generated |Run bebop compiler for Elixir/Rust
|3 |Mobile app not initialized |Create Dioxus project structure
|4 |VirusTotal integration incomplete |Implement HTTP client with rate limiting
|===

== 7. SEAM INTEGRATION MATRIX

The following matrix shows how components integrate:

[source]
----
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    tma-mark2 Integration Map                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ ReScript â”‚â”€â”€â”€â–¶â”‚ Phoenix  â”‚â”€â”€â”€â–¶â”‚ LiveView â”‚                  â”‚
â”‚  â”‚ Frontend â”‚    â”‚ Endpoint â”‚    â”‚  Routes  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                       â”‚               â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Bebop   â”‚â”€â”€â”€â–¶â”‚  PubSub  â”‚â—€â”€â”€â”€â”‚   Repo   â”‚â”€â”€â”€â–¶â”‚  CubDB   â”‚  â”‚
â”‚  â”‚ Protocol â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â”‚ (GenSrv) â”‚    â”‚ (B-Tree) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚               â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Rustler  â”‚â”€â”€â”€â–¶â”‚ Security â”‚â—€â”€â”€â”€â”‚ Bouncer  â”‚â”€â”€â”€â–¶â”‚ Downloadsâ”‚  â”‚
â”‚  â”‚   NIFs   â”‚    â”‚  Module  â”‚    â”‚ (Watcher)â”‚    â”‚  Folder  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Crypto  â”‚    â”‚   NLP    â”‚    â”‚ Dioxus   â”‚                  â”‚
â”‚  â”‚ (Kyber,  â”‚    â”‚ (Agrep,  â”‚    â”‚ (Mobile) â”‚                  â”‚
â”‚  â”‚ BLAKE3)  â”‚    â”‚ Similar) â”‚    â”‚          â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

== 8. RECOMMENDATIONS

=== Immediate Actions (This Week)

1. âœ“ Update license headers to AGPL-3.0-or-later
2. Create `test/` directory with basic ExUnit structure
3. Generate Bebop code: `just bebop-generate`

=== Short-Term (This Month)

1. Implement Rust NIF functions for crypto
2. Create LiveView templates for all routes
3. Add development database seeds

=== Medium-Term (Next Quarter)

1. Initialize Dioxus mobile app in `mobile/`
2. Implement OU scraping client
3. Complete feedback-o-tron learning module
4. Add comprehensive test coverage (target: 80%)

== 9. CONCLUSION

The tma-mark2 project demonstrates **excellent architectural design** with:

- Proper OTP supervision patterns
- Forward-looking post-quantum cryptography
- Cross-platform support via Guix/Nix/Burrito
- Security-first design with TLS 1.3 only and SDP model
- Clean module boundaries and GenServer patterns

The primary gaps are **implementation completeness** rather than architectural flaws:

- Rust NIFs need actual algorithm implementations
- LiveView needs template files
- Test suite needs to be created

**Overall Seams Quality: â˜…â˜…â˜…â˜…â˜† (4.3/5)**

The seams are well-defined, properly isolated, and correctly ordered.
Once the stub implementations are completed, this will be a production-ready,
security-hardened application suitable for handling sensitive academic data.

---

_Review conducted: 2025-01-02_
_Reviewer: Claude Code (Opus 4.5)_
_Next review recommended: After Rust NIF implementation complete_
